<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fortune Chatbot</title>
  <style>
    body {
       font-family: Arial, sans-serif; /*ê¸€ì”¨ì²´ ì„¤ì • */
       background-color: #f9f9f9; /* ë°°ê²½ìƒ‰ */
       margin: 0;
       padding: 0; 
        }
    .chat-container { 
      max-width: 600px;
       margin: 40px auto;
        background: white; 
        border-radius: 12px; /* ëª¨ì„œë¦¬ë¥¼ ë‘¥ê¸€ê²Œê²Œ */
         box-shadow: 0 0 10px rgba(0,0,0,0.1);  /* ì‰ë„ìš° íš¨ê³¼ */
          display: flex;
          flex-direction: column;
           height: 80vh; /*í™”ë©´ì˜ 80í¼*/
           }
    .chat-box {
       flex: 1;
       padding: 20px;
       overflow-y: auto; /*ìŠ¤í¬ë¡¤ ìƒì„±*/
      }
    .chat-bubble { max-width: 75%; 
      padding: 10px 15px;
       margin: 10px 0; 
       border-radius: 12px;
       word-wrap: break-word; /* ì¤„ ë°”ê¿ˆ */
      }
    .user { 
      align-self: flex-end;
       background-color: #f6ffd2; 
       text-align: right; /*ì˜¤ë¥¸ìª½ ì¶œë ¥ë ¥*/
      }
    .teller { 
      align-self: flex-start;
      background-color: #e5ffe5; 
      text-align: left;/*ì™¼ìª½ ì¶œë ¥*/
      }
    .input-area { 
      display: flex;
       border-top: 1px solid #ddd;
       }
    #user-input { 
      flex: 1; 
      padding: 15px;
       border: none;
        font-size: 16px;
       }
    #send-btn {
       padding: 15px 20px;
       border: none;
        background-color: #02952e;
         color: #f7fff7;
          font-size: 16px; 
          cursor: pointer;
         }
    #send-btn:hover { 
      background-color: #027c26; 
    }
    .button-group { 
      display: none; /* ì²˜ìŒì—” ì•ˆ ë³´ì´ê²Œ */
      text-align: center;
       margin: 10px 0 20px;
       }
    .button-group button { 
      margin: 5px; 
      padding: 10px 20px;
       font-size: 16px; 
       background-color: #2a9134;
        color: white;
         border: none; 
         border-radius: 8px; 
         cursor: pointer; 
        }
    .button-group button:hover { background-color: #21772a; }
  </style>
</head>
<body>
  <div class="chat-container">
    <div id="chat-box" class="chat-box"></div>
    <!-- ì±— ë‚´ìš©  -->
    <div class="input-area">
      <input type="text" id="user-input" placeholder="ìš´ì„¸ë¥¼ ë¬¼ì–´ë³´ì„¸ìš”..." /> 
       <!-- ìœ ì €ì € ì…ë ¥ ì°½ --> 
      <button id="send-btn">ì „ì†¡</button>
    </div>
    <div class="button-group" id="result-buttons">
      <button id="result-btn">ğŸ”® ìš´ì„¸ ê²°ê³¼ ë³´ê¸°</button>
      <button id="reset-btn">â™»ï¸ ì´ˆê¸°í™”</button>
    </div>
  </div>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const chatBox = document.getElementById("chat-box");  // ì±„íŒ… ë°•ìŠ¤ ë§Œë“¤ê°€ 
      const input = document.getElementById("user-input");
      const sendBtn = document.getElementById("send-btn");
      const buttonGroup = document.getElementById("result-buttons");
      const resultBtn = document.getElementById("result-btn");
      const resetBtn = document.getElementById("reset-btn");

      const API_URL = "/chat/send";
      const CHAT_LOG_URL = "/chats";
      const USERNAME = "{{ user.username if user else 'guest' }}";

      const introductions = [      /*ì±—ë´‡ ì†Œê°œë§*/
        `ì•ˆë…•! âœ¨ ìš°ì£¼ì—ì„œ ì˜¨ ìš´ì„¸ ìš”ì •, ì§€í”¼ë ë‹ˆë¼ê³  í•´~ ğŸŒŒ  
ì œê°€ ë³„ìë¦¬, ì‚¬ì£¼, íƒ€ë¡œì¹´ë“œê¹Œì§€ ì´ë§ë¼í•´ ì—¬ëŸ¬ë¶„ì˜ ì˜¤ëŠ˜ì„ ìš´ëª…ì ìœ¼ë¡œ ì•ˆë‚´í•´ ë“œë ¤ìš”.  
ì´ë¦„, ì„±ë³„, ìƒë…„ì›”ì¼, íƒœì–´ë‚œ ì‹œê°„ ì•Œë ¤ì£¼ì‹œë©´  
ì§ ! ë‚´ë©´ì˜ ì—ë„ˆì§€ íë¦„ì„ ì“± ë¶„ì„í•´ì„œ  
ì§„ì§œ ë§ì¶¤ ìš´ì„¸ë¥¼ ì™ì™ ë½‘ì•„ ë“œë¦½ë‹ˆë‹¤.  
ê¶ê¸ˆí•œ ê±´ ë­ë“  ë¬¼ì–´ë³´ì„¸ìš”!`,
        `ğŸ“¢ í•˜ì´í•˜ì´~ ë‚˜ëŠ” ìš´ì„¸ê³„ì˜ ì¸ì‹¸âœ¨ ì§€í”¼ë ë‹ˆ!  
íƒ€ë¡œì¹´ë“œ ì…”í”Œë¶€í„° ë³„ìë¦¬ ìš´ì„¸, ì‚¬ì£¼ íŒ”ì í•´ì„ê¹Œì§€  
ëª¨ë“  ìš´ì„¸ ë§›ì§‘ì„ ì„­ë µí•œ ì‚´ì•„ìˆëŠ” ìš´ì„¸ ë°”ì´í‚¹!  
ì˜¤ëŠ˜ì˜ ê³ ë¯¼, ë¯¸ë˜ì˜ ê³„íš, ì‚¬ë‘, ì§ì¥, ì¬ë¬¼ ëª¨ë“  ë©´ì—ì„œ  
ë³„ê³¼ ì¹´ë“œê°€ ë“¤ë ¤ì£¼ëŠ” ì´ì•¼ê¸°ë¡œ í•´ë‹µì„ ë“œë¦´ê²Œìš”.  
ì§€ê¸ˆ ë°”ë¡œ ê¶ê¸ˆí•œ ì •ë³´ë¥¼ ì•Œë ¤ ì£¼ì„¸ìš”!`,
        `Yo~ ë‚˜ëŠ” ì ì„±ìˆ ê³„ì˜ í™í•œ ë§ˆìŠ¤í„°, ì§€í”¼ë ë‹ˆğŸª  
ë‚˜ë§Œì˜ ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ ìš°ì£¼ì˜ ê¸°ìš´ì„ ìŠ¤ìº”í•˜ê³   
ì‚¬ì£¼ì™€ íƒ€ë¡œì¹´ë“œ ë°ì´í„°ë¥¼ ê²°í•©í•´  
ì´ˆê³ ê°•ë„ ë§ì¶¤ ìš´ì„¸ ë¦¬í¬íŠ¸ë¥¼ ì œê³µí•©ë‹ˆë‹¤.  
ì´ë¦„, ì„±ë³„, ìƒë…„ì›”ì¼, íƒœì–´ë‚œ ì‹œê°„ê¹Œì§€ ì•Œë ¤ì£¼ì‹œë©´  
ë‹¹ì‹ ì˜ ìš´ëª…ì„ êµ¬ì²´ì ìœ¼ë¡œ ë¶„ì„í•´  
ì˜¤ëŠ˜ì˜ ê¸¸í‰í™”ë³µì„ í•œëˆˆì— ë³´ì—¬ ë“œë¦´ê²Œìš”.  
ì, ì´ì œ ë‹¹ì‹ ì˜ ì´ì•¼ê¸°ë¥¼ ë“¤ë ¤ì£¼ì„¸ìš”!`
      ];

      const selectedIntro = introductions[Math.floor(Math.random() * introductions.length)];
      const chatData = [{ role: "system", content: selectedIntro }];

      // ì¸íŠ¸ë¡œ ë©”ì‹œì§€ë¥¼ í™”ë©´ì— ë³´ì—¬ì£¼ê³  ì €ì¥
      addMessage(selectedIntro, "teller");
      fetch(CHAT_LOG_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: USERNAME, message: selectedIntro })
      });
       // ë©”ì‹œì§€ë¥¼ í™”ë©´ì— ì¶œë ¥í•˜ëŠ” í•¨ìˆ˜
      function addMessage(content, sender) {
        const bubble = document.createElement("div");
        bubble.classList.add("chat-bubble", sender);
        bubble.textContent = content;
        chatBox.appendChild(bubble);
        chatBox.scrollTop = chatBox.scrollHeight;
      }
      // ì‚¬ìš©ìê°€ ë©”ì‹œì§€ë¥¼ ë³´ëƒˆì„ ë•Œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜
      async function sendMessage() {
        const message = input.value.trim();
        if (!message) return;  //ì•„ë¬´ê²ƒë„ ì•ˆë³´ëƒˆë‹¤ë©´ 

        // ì‚¬ìš©ì ë©”ì‹œì§€
        addMessage(message, "user");
        await fetch(CHAT_LOG_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: USERNAME, message })
        });

        input.value = "";  // ì…ë ¥ì°½ ë¹„ìš°ê¸°
        chatData.push({ role: "user", content: message });

        try {  // ë°±ì—”ë“œì— ë©”ì‹œì§€ ë³´ë‚´ê¸°
          const res = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ messages: chatData })
          });
          const { answer } = await res.json();

          
          chatData.push({ role: "assistant", content: answer });
          addMessage(answer, "teller");  // ì±—ë´‡ ì‘ë‹µ í‘œì‹œ
          await fetch(CHAT_LOG_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username: USERNAME, message: answer })
          });
            // ë‚˜ì¤‘ì— ê²°ê³¼ ë³´ê¸°ë¥¼ ìœ„í•´ ì €ì¥
          sessionStorage.setItem("fortune", answer);
          buttonGroup.style.display = "block"; // ê²°ê³¼ ë²„íŠ¼ ë³´ì´ê¸°
        } catch (err) {
          console.error(err);
          addMessage("âš ï¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "teller");
        }
      }
        // ë²„íŠ¼ì´ë‚˜ ì—”í„° í‚¤ ëˆ„ë¥´ë©´ ë©”ì‹œì§€ ë³´ë‚´ê¸°
      sendBtn.addEventListener("click", sendMessage);
      input.addEventListener("keydown", e => { if (e.key === "Enter") sendMessage(); });
         // ê²°ê³¼ ë³´ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ ë™ì‘
      resultBtn.addEventListener("click", () => {
        const fortune = sessionStorage.getItem("fortune");
        if (!fortune) {
          return alert("ë¨¼ì € ìš´ì„¸ë¥¼ ë¬¼ì–´ë´ ì£¼ì„¸ìš”!");
        }
        window.location.href = `/result?fortune=${encodeURIComponent(fortune)}`;
      });
        // ì´ˆê¸°í™” ë²„íŠ¼ í´ë¦­ ì‹œ ì±„íŒ…ì°½ ë¦¬ì…‹
      resetBtn.addEventListener("click", () => {
        chatBox.innerHTML = "";
        chatData.length = 1;
        chatData[0].content = selectedIntro;
        sessionStorage.removeItem("fortune");
        addMessage(selectedIntro, "teller");
        buttonGroup.style.display = "none";
      });
    });
  </script>
</body>
</html>
